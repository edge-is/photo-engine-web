function parseJSON(a){try{return JSON.parse(a)}catch(b){return!1}}function controllerArchive(a,b,c,d,e,f,g,h){var i=b.current.params.archiveID;a.limit=30,a.offset=0,a.DefaultImage="small",a.archiveImages=[],a.scrollDisabled=!0,a.loadedImages=0,a.filters={},a.queryString="",a.showSidebar=!0,a.displayResultCount=!1,a.navSearch="",a.archive="",a.root=e.location.hash.replace(/\#/g,""),a.filters.archive_id=i,a.searchTime=0;var j=h.createURI([config.api,"/aggregates/archive"].join(""),{filter:"archive_id:"+i});c.get(j).then(function(b){var c=b.data.data.results;c.length>0&&(a.archive=c[0].name)}),a.requestQuery=function(b,d,e,f){f=f||function(){};var i=[];if(a.filterString=function(a){var b=[],c="";for(var d in a){var e=a[d];b.push([d,e].join(":"))}return c+=b.join(",")}(a.filters),a.filterString+=i.join(","),a.queryString||(a.queryString=""),a.queryString.length>1&&g.search("query",a.queryString),a.filters.length>1){var j=angular.copy(a.filters);delete j.archive_id,g.search("filter",j)}var k=[config.api,"/search/query?"].join(""),l=h.createURI(k,{limit:b,offset:d,query:a.queryString,filter:a.filterString});a.scrollDisabled=!0,c.get(l).then(function(b){e&&(a.archiveImages=[]),a.displayResultCount=!0,a.searchTime=b.data.data._took,b.data.data.hits.forEach(function(b){a.archiveImages.push(b)}),a.loadedImages=a.archiveImages.length,a.availableImagesCount=b.data.data._total,a.loadedImages<=a.availableImagesCount&&(a.scrollDisabled=!1)},f)},a.photographersapi=[config.api,"/aggregates/Credit"].join(""),a.searchDelay=300,a.searching=!1,a.addToFilter=function(b,c){a.filters[b]===c?delete a.filters[b]:a.filters[b]?(delete a.filters[b],a.filters[b]=c):a.filters[b]=c,a.requestQuery(a.limit,0,!0)},a.submitNavSearch=function(){a.queryString=a.navSearch,a.requestQuery(a.limit,0,!0)},a.setImagesInCache=function(b,c){d.images=a.archiveImages,d.image=c,d.index=b},a.load_more_data=function(b){a.requestQuery(a.limit,a.loadedImages,!1,b)};var k=g.search().query;"string"==typeof k&&(a.queryString=k,a.navSearch=k),a.requestQuery(a.limit,0,!1)}function archiveController(a,b){var c=[config.api,"/aggregates/archive"].join("");a.archives=[],b.get(c).success(function(b){a.archives=b.data.results})}function directiveBackgroundImage(){return{restrict:"ACE",link:function(a,b,c){var d=["url(",c.backgroundImage,")"].join("");b.css({"background-image":d})}}}function directiveFilterList(a,b){return{restrict:"ACE",template:function(a,b){var c="'"+b.filterKey+"'";return'<li ng-repeat="item in '+b.dataset+'"><a href ng-click="addToFilter('+c+', item.name)"><input ng-checked="filters['+c+'] === item.name" type="checkbox"> {{item.name}} <span class="pull-right">{{item.count}}</span></a></li>'},link:function(c,d,e,f){function g(){return c[e.query]}function h(){return c[e.filter]}function i(d,f){var g={};g.filter=f||!1,g.query=d||!1;var h=b.createURI(j,g);"?"!==h&&a.get(h).then(function(a){c[e.dataset]=a.data.data.results})}var j=e.api;console.log(e),e.filter&&c.$watch(e.filter,function(a,b){i(g(),h())}),e.query&&c.$watch(e.query,function(a,b){i(g(),h())}),i()}}}function directiveLazyImage(a){return{restrict:"ACE",template:function(a,b){return'<img class="low-resolution-image" ng-src="'+b.lowres+'"></img><img class="hidden high-resolution-image" ng-src="'+b.highres+'"></img>'},link:function(b,c,d){$(".high-resolution-image").bind("load",function(){$(".low-resolution-image").addClass("hidden"),b.$apply(),a(function(){$(".high-resolution-image").removeClass("hidden").unbind("load")},10),$(".low-resolution-image").remove()})}}}function typeaheadDirective(){return{restrict:"ACE",scope:{enabled:"&MainSearchHidden"},transclude:!0,link:function(a,b,c){return console.log(b,a,c),"HELLO"}}}function directiveRandomArchiveImage(a,b){return{restrict:"ACE",template:function(a,b){return'<div class="carousel slide archives-carousel" data-ride="carousel"><div class="carousel-inner" role="listbox"><div class="item active"><div class="background-thumbnail"></div><div class="carousel-caption"><h5>{{archive_name}}</h5></div></div></div></div>'},replace:!0,link:function(c,d,e){c.availableImages=[],c.archive_name=e.archiveName,c.image_name="";var f=[config.api,"/random/archives?archive_id=",e.archive].join("");a.get(f).success(function(a){c.availableImages=a.data.hits;var e=a.data.hits.pop();c.image_name=e._id,c.selectedArchiveImage=e._source.cdn1.small,d.attr("background-image",c.selectedArchiveImage),b(d)(c)})}}}function directiveTypeaheadSuggest(a){return{restrict:"ACE",replace:!0,require:"?ngModel",template:function(a,b){return'<input type="text" ng-mode="'+b.ngModel+'" class="'+b["class"]+'">'},link:function(b,c,d,e){function f(a,b){return a.score<b.score?-1:a.score>b.score?1:0}function g(a,b){var c=a.join(" ");return b.map(function(a){return[c,a].join(" ")})}function h(a){var b=[];for(var c in a.suggest){var d=a.suggest[c];0!==d.length&&d[0].options.forEach(function(a){b.push(a)})}var e=b.sort(f).reverse(),g=e.map(function(a){return a.text});return g}function i(){return function(b,c,d){var e=b.split(" "),f=e.pop();a(f).then(function(a){var b=h(a.data.data);b=g(e,b),d(b)},function(){d([])})}}function j(a,c,d){k(a,c,d),b.$apply(function(){var a=angular.isDefined(b.suggestionKey)?c[b.suggestionKey]:c;e.$setViewValue(a)})}console.log(b,e,d);var k=function(){};"function"==typeof b[d.submit]&&(k=b[d.submit]),$(c).typeahead({hint:!0,highlight:!1,minLength:1,async:!0},{async:!0,name:"suggester",source:i()}),c.bind("typeahead:selected",function(a,c,d){j(a,c,d),b.$emit("typeahead:selected",c,d)}),c.bind("typeahead:autocompleted",function(a,c,d){j(a,c,d),b.$emit("typeahead:autocompleted",c,d)}),c.bind("typeahead:opened",function(){b.$emit("typeahead:opened")}),c.bind("typeahead:closed",function(){b.$emit("typeahead:closed")}),c.bind("typeahead:asyncrequest",function(){b.$emit("typeahead:asyncrequest")}),c.bind("typeahead:asynccancel",function(){b.$emit("typeahead:asynccancel")}),c.bind("typeahead:asyncreceive",function(){b.$emit("typeahead:asyncreceive")}),c.bind("typeahead:cursorchanged",function(a,c,d){b.$emit("typeahead:cursorchanged",a,c,d)})}}}function factorySharedImages(){return{startUrl:"/",index:null,image:null,images:[],loaded:!1}}function serviceImage(a){return{getImageByID:function(b){var c=[config.api,"/image/",b].join("");return a.get(c)}}}function serviceSuggester(a){return function(b,c,d){d=d||{};var e=[config.api,"/search/suggest?"].join(""),f=d.url||e,g=[f,"filter=",c,"&query=",b].join("");return a.get(g)}}function serviceUtils(){return{createURI:function(a,b){var c=[];for(var d in b){var e=b[d];e&&c.push([d,e].join("="))}var f=c.join("&");return[a,f].join("?")},each:function(a,b){!function(a,b){for(var c in a)b(c,a[c])}(a,b)}}}var search=angular.module("search",["siyfion.sfTypeahead","ui.bootstrap","ngRoute","nemLogging","leaflet-directive","cfp.hotkeys","ui.select","ngSanitize","angularScroll"]);search.run(["$rootScope","$location",function(a,b){var c=["imageLinked"];a.history=[],a.$on("$routeChangeSuccess",function(d,e){e.$$route&&-1===c.indexOf(e.$$route.controller)&&a.modalInstance&&a.modalInstance.close(),a.history.push(b.$$path)})}]);var settings={search:{fields:{BitsPerSample:{type:"long"},CaptionWriter:{type:"string"},Category:{type:"string"},City:{type:"string"},ColorComponents:{type:"long"},ColorMode:{type:"string"},Comment:{type:"string"},Country:{type:"string"},Credit:{type:"string"},DateCreated:{type:"date"},Description:{type:"string"},Directory:{type:"string"},ExifImageHeight:{type:"long"},ExifImageWidth:{type:"long"},FileName:{type:"string"},FileType:{type:"string"},ImageHeight:{type:"long"},ImageWidth:{type:"long"},Instructions:{type:"string"},Keywords:{type:"string"},LocalCaption:{type:"string"},MIMEType:{type:"string"},ObjectName:{type:"string"},Orientation:{type:"string"},PhotometricInterpretation:{type:"string"},ProfileFileSignature:{type:"string"},ReleaseDate:{type:"date"},Rights:{type:"string"},Source:{type:"string"},SourceFile:{type:"string"},SpecialInstructions:{type:"string"},State:{type:"string"},Subject:{type:"array"},SupplementalCategories:{type:"array"},Title:{type:"string"},XResolution:{type:"long"},YResolution:{type:"long"},safn:{type:"string"}}}};search.config(["$routeProvider","$locationProvider","uiSelectConfig",function(a,b,c){c.theme="bootstrap";b.html5Mode({enabled:!1,requireBase:!1}),a.when("/",{controller:"main",reloadOnSearch:!1,templateUrl:"views/main.html"}).when("/archives",{controller:"archives",reloadOnSearch:!1,templateUrl:"views/archives.html"}).when("/archive/:archiveID",{controller:"archive",reloadOnSearch:!1,templateUrl:"views/archive.html"}).when("/image/:imageID",{controller:"imageLinked",reloadOnSearch:!1,templateUrl:"views/image.html"}).otherwise({controller:"main",reloadOnSearch:!1,templateUrl:"views/main.html"})}]),search.controller("archive",["$scope","$route","$http","imageCache","$window","$timeout","$location","utils",controllerArchive]),search.controller("archives",["$scope","$http",archiveController]),search.controller("imageModalController",["$scope","$location","$modalInstance","data","map","hotkeys","$rootScope",function(a,b,c,d,e,f,g){function h(b){(document.webkitIsFullScreen===!1||document.mozFullScreen===!1||null===document.msFullscreenElement)&&(a.isFullscreen=!1,a.fullscreenClass="no-fullscreen",console.log("EXIT?"))}a.index=d.index,a.images=d.results,a.image=d.image,a.isFullscreen=!1,a.fullscreenClass="no-fullscreen",a.root=d.root,a.currentLocation=b.$$url,a.close=function(){c.close()},a.dismiss=function(){c.dismiss()},a.nextImg=a.images[a.index+1],a.prevImg=a.images[a.index-1],a.next=function(){a.index+1<a.images.length&&(a.StopLazy(),a.index=a.index+1,a.image=a.images[a.index],a.nextImg=a.images[a.index])},a.prev=function(){a.index>0&&(a.StopLazy(),a.index=a.index-1,a.image=a.images[a.index],a.prevImg=a.images[a.index])},a.nextURL=function(){return a.nextImg?"#/image/"+a.nextImg._id:void 0},a.prevURL=function(){return a.prevImg?"#/image/"+a.prevImg._id:void 0},a.isNext=function(){var b=a.images.length;return a.index+1>=b?!1:!0},a.isPrev=function(){return 0==a.index?!1:!0},a.landscape=function(a){return a._source.ImageWidth<a._source.ImageHeight?!1:!0},g.$on("$locationChangeStart",function(a,b){console.log(a,b)}),a.StopLazy=function(){$(".high-resolution-image").unbind("load")};var i="webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange";$(document).on(i,h),a.fullscreen=function(){var b=document.getElementById("preview_carousel");b.requestFullscreen?b.requestFullscreen():b.webkitRequestFullscreen?b.webkitRequestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.msRequestFullscreen&&b.msRequestFullscreen(),a.fullscreenClass="fullscreen",a.isFullscreen=!0},f.bindTo(a).add({combo:"right",description:"Select next image.",callback:function(){a.next()}}).add({combo:"left",description:"Select prev image",callback:function(){a.prev()}}),a.center={},a.defaults={scrollWheelZoom:!1},a.mapmarker={},a.Map=function(){a.MapLoaded=!1;var b={},c=!1;"City"in a.image._source?(c=!0,b.city=a.image._source.City):"State"in a.image._source&&(c=!0,b.state=a.image._source.State),"Country"in a.image._source&&a.image._source.Country.split(" ").length<=2&&(b.Country=a.image._source.Country),1==c&&e.osm(b).then(function(b){b.length>0&&(a.MapLoaded=!0,a.center={lat:+b[0].lat,lng:+b[0].lon,zoom:4},a.mapmarker={m1:{lat:+b[0].lat,lng:+b[0].lon,message:"Wazzuuup?",icon:"img/map-marker.png"}})})}}]),search.controller("imageLinked",["$scope","$route","imageService","$uibModal","$location","imageCache","$window","$rootScope","$location",function(a,b,c,d,e,f,g,h,e){function i(a){return a.data[0][0]}function j(a,b,c){var g=d.open({templateUrl:"views/image-modal.html",controller:"imageModalController",size:"lg",animation:!1,resolve:{data:function(){return{root:k,index:a,image:b,results:c}}}});h.modalInstance=g,g.result.then(function(a){f.loaded=!1;var b=k;console.log(b),e.url(b)},function(){f.loaded=!1})}if(!f.loaded){var k=e.search().root||"/";a.lastURI=h.history[h.history.length-2],a.imageID=b.current.params.imageID,f.index||0===f.index?(j(f.index,f.image,f.images),f.loaded=!0):c.getImageByID(a.imageID).then(function(a){if(a.data){var b=i(a.data);j(0,b,[])}})}}]),search.controller("main",["$scope","$window","_search","$uibModal","$log","$location","imageCache",function(a,b,c,d,e,f,g){function h(b,d,e){d=d||"query",angular.element("#mainsearch").focus(),a.MainSearchHidden=!1,a.StartSearchHidden=!0,angular.element("body")[0].scrollTop=0,c.query(a.mainSearchQuery,a.mainSearchOptions).then(function(b){a.displayResultCount=!0,a.searchTime=b.data._took,a.searchResultsTotal=b.data._total,a.mainSearchHits=b.data.hits,a.submittedQuery=a.mainSearchQuery,a.mainSearchSize=b.data.hits.length}),a.lastSearchURI=f.$$url}console.log("what the fuck",angular.element("#mainsearch").attr("sf-typeahead")),a.photographersapi=[config.api,"/aggregates/Credit"].join(""),a.MainSearchHidden=!0,a.MainSearch="",a.StartSearch="",a.typeaheadquery="",a.searchTime=0,a.searchResultsTotal=0,a.mainSearchHits=[],a.displayResultCount=!1,a.scrollDisabled=!1,a.mainSearchOptions={limit:30,offset:0};var i=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.num)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:config.api+"/search/typeahead?query={query}*",wildcard:"{query}",filter:function(a){return a.data.hits}}});i.clear(),i.initialize(),a.TypeaheadEngineData={displayKey:"hit",source:i.ttAdapter()},a.TypeaheadOptions={highlight:!0},a.mainSearchQuery=f.search().query||"",a.mainSearchFilter=f.search().filter||"",(""!==a.mainSearchQuery||""!==a.mainSearchFilter)&&(setTimeout(function(){a.MainSearch=a.mainSearchQuery,a.$apply()},100),h(a.mainSearchQuery)),a.$watch("StartSearch",function(b,c){a.StartSearch.length>0&&(angular.element("#mainsearch").focus(),a.MainSearchHidden=!1,setTimeout(function(){a.StartSearchHidden=!0},20)),a.MainSearch=a.StartSearch}),a.submitMainSearch=function(){a.MainSearch.hit?a.mainSearchQuery=a.MainSearch.hit:a.mainSearchQuery=a.MainSearch,a.setURI(),h(a.mainSearchQuery)},a.setURI=function(){var b={};""!==a.mainSearchQuery&&(b.query=a.mainSearchQuery),""!==a.mainSearchFilter&&(b.filter=a.mainSearchFilter),f.search(b)},a.$on("typeahead:selected",function(b,c,d){a.MainSearch.hit?a.mainSearchQuery=a.MainSearch.hit:a.mainSearchQuery=a.MainSearch,a.setURI(),h(a.mainSearchQuery)}),a.landscape=function(a){return a._source.ImageWidth<a._source.ImageHeight?!1:!0};var j=angular.element(b);a.windowWidth=j.width(),a.DefaultImage="x-small",a.load_more_data=function(b){if(!(a.mainSearchSize<1)){var d={limit:a.mainSearchOptions.limit,offset:a.mainSearchSize};c.query(a.submittedQuery,d).then(function(c){c&&(c.data.hits.length<1||(a.searchTime=c.data._took,a.searchResultsTotal=c.data._total,c.data.hits.forEach(function(b){a.mainSearchHits.push(b)}),a.mainSearchSize+=c.data.hits.length,b()))})}},a.openImage=function(a,b,c){g.image=b,g.index=a,g.images=c},a.openAdvancedSearch=function(b,e,g){var h=d.open({templateUrl:"views/advanced-search-modal.html",controller:"AdvancedSearchController",size:"lg",resolve:{data:function(){return{}}}});h.result.then(function(a){var b=c.advancedSearch(a,{});b.success(function(a){console.log(a)})},function(){f.url(a.lastSearchURI)})}}]),search.controller("AdvancedSearchController",["$scope","$modalInstance","data","translate",function(a,b,c,d){var e=function(){return{bool:"AND",key:"",operator:"==",query:""}};a.advanced_search_query=[new e],a.advanced_search_fields=[],$.each(settings.search.fields,function(b,c){var e=d(b),f=b;e&&(f=e.name),a.advanced_search_fields.push({name:f,key:b})}),a.advanced_search_add=function(b){a.advanced_search_query.push(new e)},a.advanced_search_remove=function(b){a.advanced_search_query.splice(b,1)},a.search=function(){console.log(a.advanced_search_query),b.close({query:a.advanced_search_query})},a.close=function(){b.dismiss()}}]),search.directive("backgroundImage",[directiveBackgroundImage]),search.directive("filterList",["$http","utils",directiveFilterList]),search.directive("lazyimg",["$timeout",directiveLazyImage]),search.directive("typeaheadsearch",typeaheadDirective),search.directive("randomArchiveImage",["$http","$compile",directiveRandomArchiveImage]),search.directive("typeaheadSuggest",["suggester",directiveTypeaheadSuggest]),search.factory("imageCache",factorySharedImages),search.filter("ms",[function(){return function(a){var b=a/1e3;return isNaN(b)?"":b+"s"}}]),search.filter("propsFilter",function(){return function(a,b){var c=[];return angular.isArray(a)?a.forEach(function(a){for(var d=!1,e=Object.keys(b),f=0;f<e.length;f++){var g=e[f],h=b[g].toLowerCase();if(-1!==a[g].toString().toLowerCase().indexOf(h)){d=!0;break}}d&&c.push(a)}):c=a,c}}),search.service("imageService",["$http",serviceImage]),search.service("suggester",["$http",serviceSuggester]),search.service("utils",serviceUtils),search.service("_search",["$http","$q",function(a,b){function c(b,c){return a.post(b,c)}return{typeahead:function(a){},filter:function(a){},advancedSearch:function(a,d){d||(d={});var e=d.limit||30,f=d.offset||0,g=(b.defer(),[config.api,"/search/advanced?"].join(""));return g+="limit="+e,g+="&offset="+f,c(g,a)},query:function(c,d){d||(d={});var e=d.limit||30,f=d.offset||0,g=b.defer(),h=[config.api,"/search/query?"].join("");return h+="limit="+e,h+="&offset="+f,h+="&query="+c,a.get(h).success(function(a){g.resolve(a)}).error(function(a){g.reject(a)}),g.promise}}}]),search.service("map",["$http","$q",function(a,b){return{osm:function(c){var d=b.defer(),e={url:"https://nominatim.openstreetmap.org/search.php",method:"GET",params:c};return e.params.format="json",a(e).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise}}}]),search.service("translate",[function(){return function(a){if("lang"in window==!1)return{name:a};if(a in lang){var b=lang[a];return""!==b.name?b:{name:a}}return{name:a}}}]);
//# sourceMappingURL=application.min.js.map